主从复制，是指将一台`Redis`服务器上的数据，复制到其他的`Redis`服务器。前者称为主节点(master/leader)，后者称为从节点
(slave/follower)，数据的复制是单向的，只能由主节点到从节点，`master`以写为主，`slave`以读为主

默认情况下，每台`Redis`服务器都是主节点，且一个主节点可以有多个从节点或没有从节点，但一个从节点只能有一个主节点

**主从复制的作用**

- 数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式
- 故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复，实际上是一种服务的冗余
- 负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，从节点提供读服务，分担服务器的压力，
  尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高`Redis`服务器的并发量
- 读写分离：可以用于实现读写分离，主节点写，从节点读，读写分离不仅可以提高服务器的负载能力，同时可根据需求的变化，改变从节点的数量
- 高可用基石：主从复制是哨兵和集群能够实施的基础，所以说主从复制是`Redis`高可用的基础

一般来说，在实际项目中，只使用一台`Redis`是不行的：

- 从结构上，单个`Redis`服务器会发生单点故障，并且一台服务器需要处理所有的请求，压力较大
- 从容量上，单个`Redis`服务器内存容量有限，一般来说，单台`Redis`最大使用内存不应该超过20G

**环境配置**

注意：主从复制的开启，完全是在从节点发起的，不需要我们在主节点做任何事情

```bash
# 查看当前库的信息
127.0.0.1:6379> info replication
# Replication
# 角色
role:master
# 连接的从库数量
connected_slaves:0
master_repl_offset:0
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
```

复制三个配置文件，并修改对应的信息

- 端口
- pid名称
- log文件名称
- dump.rdb名称

修改完配置后，使用不同的配置启动服务

从节点开启主从复制，有3种方式：

**1.客户端命令行**

```bash
# 配置 Master
slaveof 127.0.0.1 6379
```

**2.配置文件**

```bash
replicaof <masterip> <masterport>
```

**3.启动命令**
`redis-server`启动命令后加入`--slaveof <masterip> <masterport>`

**复制原理**

从数据库启动成功连接到主数据库后会发送一个同步的命令，主数据库接收到命令后，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台执行完毕后，会发送整个数据文件到从数据库，并完成一次同步。

- 全量复制：从数据库在接收到数据文件后，将其存盘并加载到内存中
- 增量复制：主数据库继续将新的所有收集到的修改命令依次传给从数据库，完成同步

但是只要重新连接到主数据库，一次完全同步（全量同步）将被自动执行

**宕机后手动配置新主机**

如果主节点断开了连接，我们可以使用`slave no one`让当前数据库变成主数据库，其他的节点就可以手动连接到最新的这个主节点，如果这时候主节点修复了，那就重新连接。

`Redis`是基于内存的数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库状态也会消失。

#### `RDB（Redis DataBase）`

在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是`Snapshot`，它恢复时是将快照文件直接读取到内存中。

`Redis`会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时的文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何`IO`操作的，这就确保了极高的性能，如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那`RDB`方式要比`AOF`方式更加的高效，`RDB`的缺点是最后一次持久化后的数据可能会丢失。

**触发机制**

- `save`的规则满足
- 执行了`flushall`
- 退出`Redis`

备份就会自动生成一个`dump.rdb`

**恢复`rdb`文件**

只需要将`rdb`文件放在我们的`redis`启动目录就可以，`redis`启动的时候会自动检查`dump.rdb`恢复其中的数据

```bash
# 查看目录
config get dir
1) "dir"
2) "/usr/local/bin"
```

如果再这个目录下存在`dump.rdb`文件，那么启动的时候`redis`就会自动恢复其中的数据

**优点**

- 真个数据库将只包含一个文件，这对于备份文件来说是非常完美的，比如，我们可以每小时备份最近24小时的数据，同时每天备份最近30天的数据，通过这样的备份策略，一旦系统出现灾难性故障，我们可以非常容易的恢复。
- 便于存储备份。对于灾难性恢复而言，`RDB`是一个非常不错的选择，因为我们可以非常轻松的将一个单独的文件压缩后转移到其他的存储介质上。
- 性能最大化。对于`Redis`服务进程而言，在开始持久化时，它唯一需要做的只是`fork`一个子进程，所有的持久化操作全部由子进程完成，这样就可以极大的避免服务进程执行`IO`操作了。
- 相比于`AOF`机制，如果数据集很大，`RDB`的启动效率会高很多。

**缺点**

- 无法保证数据的高可用性，即要最大限度的避免数据丢失，`RDB`则不是一个最好的选择，因为系统一旦在定时持久化之前出现宕机现象，那么未持久化的数据将全部丢失。
- 由于`RDB`是通过`fork`子进程的方式来协助完成数据的持久化工作的，因此，当数据集较大时，可能会导致整个服务器停止服务一段时间。

#### `AOF(Append Only File)`

将我们所有的操作都记录下来形成历史文件，恢复的时候会将这个历史文件中的命令重新执行一次。

以日志的形式来记录每个写操作，将`Redis`执行过的所有指令记录下来，只许追加文件不许改写文件，`Redis`启动时会读取该文件重新构建数据，即`Redis`重启时会加载读取该文件，将记录的操作命令从新执行一遍

```bash
# 开启aof
appendonly yes
# 指定aof文件的名称
appendonlyfilename "appendonly.aof"
```

`aof`默认是不开启的，我们需要手动配置，即将`appendonly`的值修改为`yes`就开启了，修改完配置后需要重启`Redis`即可生效

注意：如果`.aof`文件中的内容出现错误，`Redis`无法启动成功，我们可以使用`redis-check-aof`这个工具对其进行修复：`redis-check-aof --fix`，修复成功后可以成功启动

**优点**

- 更高的保证数据的安全性，`Redis`提供了三种同步策略，即`每秒同步`、`每次修改同步`、`不同步`；事实上，`每秒同步策略`也是异步完成的，所以效率也是非常的高，不足之处是一旦系统出现宕机现象，那么这一秒内的数据将会丢失；`每次修改同步策略`，我们可以将其视为同步持久化，即每次发生的数据变化都会被记录到磁盘中，因此这种方式在效率上是最低的。
- 由于该机制对日志文件的写入操作采用的是`append`模式，因此在写入的过程中即使出现宕机现象，也不会破坏日志文件中已经存在的内容，只是会出现日志记录不完整的情况，`Redis`下一次启动之前我们可以使用修复工具解决数据一致性的问题。
- 如果日志过大，`Redis`可以自动启用`rewrite`机制。即`Redis`以`append`模式不断的将修改的数据写入到老的磁盘文件中，同时还会创建新的文件记录修改的命令，因此在进行`rewrite`切换时可以更好的保证数据安全性。
- `AOF`文件包含一个格式清晰、易于理解的日志文件用于记录所有的修改操作，因此，我们也可以通过该文件完成数据的重建。

**缺点**

- 对于相同的数据集而言，`aof`文件往往比`rdb`文件大，因此在恢复大数据集的时候效率会比`rdb`文件低
- 根据同步策略的不同，运行效率会低于`rdb`

**重写规则**

```bash
# 开启重写
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
# 如果aof文件大于64MB，redis会fork一个新的子进程对文件进行重写
auto-aof-rewrite-min-size 64mb
```

